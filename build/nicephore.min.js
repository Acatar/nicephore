hilary.register("nicephore::observer::maps",{init:function(){var c,d,k,f;d={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"};f={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"};for(c=1;20>c;++c)d[111+c]="f"+c;for(c=0;9>=c;++c)d[c+96]=c;return{map:d,
keycodeMap:{106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},shiftMap:{"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},reverseMap:k,aliases:f,getReverseMap:function(){if(!k){var c;k={};for(c in d)95<c&&112>c||d.hasOwnProperty(c)&&(k[d[c]]=c)}return k},callbackMap:{}}}});hilary.register("nicephore::observer::utils",{init:function(c){var d,k=Object.prototype.toString,f={};c="Boolean Number String Function Array Date RegExp Object Error".split(" ");for(var l in c){var b=c[l];f["[object "+b+"]"]=b.toLowerCase()}d=function(a){return"undefined"===typeof a?"undefined":null===a?String(a):"object"===typeof a||"function"===typeof a?f[k.call(a)]||"object":typeof a};return{preventDefault:function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},stopPropagation:function(a){a.stopPropagation?
a.stopPropagation():a.cancelBubble=!0},observeDomEvent:function(a,c,b){a.addEventListener?a.addEventListener(c,b,!1):a.attachEvent("on"+c,b)},isArray:function(a){return"array"===d(a)},isFunction:function(a){return"function"===d(a)}}}});hilary.register("nicephore::observer::helpers",{init:function(c,d,k){var f,l,b,a,m,q,n,p,r;f=function(h){return h.key+"::"+h.eventType};l=function(h,e,g,a){d.isFunction(g.func)&&!1===g.func(e,h,a)&&(d.preventDefault(e),d.stopPropagation(e))};b=function(h,e,g){a(h,g.keyInfo)&&d.isFunction(g.func)&&!1===g.func(e,h)&&(d.preventDefault(e),d.stopPropagation(e))};a=function(h,e){var a,c=!1;if(e.matchAnyModifier)for(a in h.modifiers)-1<e.modifiers.indexOf(h.modifiers[a])&&(c=!0);else{c=!0;if(h.modifiers.length!==
e.modifiers.length)return!1;for(a in h.modifiers)c=-1<e.modifiers.indexOf(h.modifiers[a])?c&&!0:!1}return c};m=function(a){return"+"===a?["+"]:a.split("+")};q=function(a){return"shift"===a||"ctrl"===a||"alt"===a||"meta"===a};n=function(a){var e=[];a.altKey&&e.push("alt");a.ctrlKey&&e.push("ctrl");a.metaKey&&e.push("meta");a.shiftKey&&e.push("shift");return e};p=function(a,e,g){g||(g=c.getReverseMap()[a]?"keydown":"keypress");"keypress"===g&&e.length&&(g="keydown");return g};r=function(a){if("keypress"===
a.type){var e=String.fromCharCode(a.which);a.shiftKey||(e=e.toLowerCase());return e}return c.map[a.which]?c.map[a.which]:c.keycodeMap[a.which]?keycodeMap[a.which]:String.fromCharCode(a.which).toLowerCase()};return{registerCallback:function(a,e){var g,b=f(a);(g=c.callbackMap[b])?g.push(e):c.callbackMap[b]=[e]},executePasteCallback:function(a,e,g){var b,d;if(d=c.callbackMap[f(a)])for(b in d)l(a,e,d[b],g)},executeCallback:function(a,e){var g,d;if(d=c.callbackMap[f(a)])for(g in d)b(a,e,d[g])},getKeyInfo:function(a,
e){var g,b,d=[];b=m(a);for(var f in b)g=b[f],c.aliases[g]&&(g=c.aliases[g]),e&&"keypress"!==e&&c.shiftMap[g]&&(g=c.shiftMap[g],d.push("shift")),q(g)&&d.push(g);e=p(g,d,e);return k.keyInfo({key:g,modifiers:d,eventType:e})},getKeyInfoFromEvent:function(a){"number"!==typeof a.which&&(a.which=a.keyCode);var e=r(a);if(e)return k.keyInfo({key:e,modifiers:n(a),eventType:a.type})}}}});hilary.register("nicephore::observer::models",{init:function(c,d){var k,f,l;k={key:null,modifiers:[],eventType:null,matchAnyModifier:!1};f={key:null,keyInfo:Object.create(k),func:function(b,a){c.log(a,b)},eventType:null};l={kind:null,type:null,file:null,dataUrl:null,toDataUrl:function(){throw Error("toDataUrl is not implemented");}};return{keyInfo:function(b){var a=Object.create(k);b.key&&(a.key=b.key);b.modifiers&&(a.modifiers=b.modifiers);b.eventType&&(a.eventType=b.eventType);return a},callback:function(b){var a=
Object.create(f);b.key&&(a.key=b.key);b.keyInfo&&(a.keyInfo=b.keyInfo);b.callback&&(a.func=b.callback);b.eventType&&(a.eventType=b.eventType);return a},pasteObject:function(b){var a=Object.create(l);b.kind&&(a.kind=b.kind);b.type&&(a.type=b.type);b.file&&(a.file=b.file);a.readToDataUrl=function(){if(d){var b=new d;b.onload=function(b){a.dataUrl=b.target.result};return b.readAsDataURL(a.file)}};return a}}}});hilary.register("nicephore::observer",{init:function(c,d,k,f,l,b){var a,m,q,n,p,r=!1,h;a=function(a,b,c,d){for(var f in a){var k=a[f];"paste"===k?q(d):m(k,b,c,d)}};m=function(a,b,c,d){var h=f.getKeyInfo(a,b);h.matchAnyModifier=c;a=k.callback({key:a,keyInfo:h,callback:d,eventType:b});f.registerCallback(h,a)};q=function(a){var c=f.getKeyInfo("paste","void");a=k.callback({key:"paste",keyInfo:c,callback:a,eventType:"void"});f.registerCallback(c,a);void 0!==document.onpaste&&(document.onpaste=function(a){var e,
d,h={items:[],json:""};d=(a.clipboardData||a.originalEvent.clipboardData).items;h.json=b.stringify(d);for(e in d){var l=d[e],m=new k.pasteObject({kind:l.kind,type:l.type});"file"===l.kind&&l.getAsFile&&(m.file=l.getAsFile(),m.readToDataUrl());h.items.push(m)}f.executePasteCallback(c,a,h)})};h=function(a){var b=f.getKeyInfoFromEvent(a);b.key&&f.executeCallback(b,a)};n=function(a,b){d.observeDomEvent(a,b,h);return this};p=function(a){n(a,"keypress");n(a,"keydown");n(a,"keyup");return this};return{start:function(){if(r)return this;
p(document);r=!0;return this},observeDomEvent:n,observeKeyEvents:p,observe:function(b,c,f,h){b=d.isArray(b)?b:[b];d.isFunction(f)?a(b,c,!1,f):a(b,c,f,h);return this},stopObserving:function(a,b){throw Error("stopObserving is not implemented");},trigger:function(a){h(a)}}}});hilary.use([window,window.FileReader,window.console,window.JSON],function(c,d,k,f,l){d.nicephore=function(){var b=hilary.resolve("nicephore::observer::maps").init(),a=hilary.resolve("nicephore::observer::utils").init(b),c=hilary.resolve("nicephore::observer::models").init(f,k),d=hilary.resolve("nicephore::observer::helpers").init(b,a,c);return hilary.resolve("nicephore::observer").init(b,a,c,d,f,l)};return d.nicephore});